<?xml version="1.0" encoding="ISO-8859-1" ?>
<project name="datafari_deploymentscript" default="deployAll" basedir=".">

	<!-- ========================= PROPERTIES ============================= -->

    <!-- Deployment properties -->
	<property name="ftp-userid" value="root" />
	<property name="ftp-password" value="password" />
	<property name="ftp-server" value="host" />
	<property name="ftp-port" value="22" />
	
	
	
	<!-- local dir -->
	<property name="project.dir" value="." />
	<property name="build.dir" value="${project.dir}/build" />
	<property name="lib.dir" value="${project.dir}/lib" />
	<property name="dist.dir" value="${project.dir}/dist" />
	<property name="tomcat.dir" value="${project.dir}/tomcat" />
	<property name="jvm.dir" value="${project.dir}/jvm" />
	<property name="pgsql.dir" value="${project.dir}/pgsql" />
	<property name="bin.dir" value="${project.dir}/bin" />
	<property name="script.dir" value="${project.dir}/script" />
	<property name="deploy.dir" value="${project.dir}/deploy" />
	<property name="project.name" value="Datafari" />
	<property name="deploy.path" value="/opt/datafari-server" />
	<property name="build.classes.dir" value="${build.dir}/classes" />
	<property name="webcontent.dir" value="${project.dir}/WebContent" />
	<property name="manifoldcf.dir" value="${project.dir}/ManifoldCF" />
	<property name="solr.dir" value="${project.dir}/Solr" />
	<property name="pre-deploy-commands" value="preCommands.txt" />
	<property name="environnementPostDeploymentCommands" value="environnementPostDeploymentCommands.txt" />
	<property name="datafariPostDeploymentCommands" value="datafariPostDeploymentCommands.txt" />
	<property name="solrConfigPostDeploymentCommands" value="solrConfigPostDeploymentCommands.txt" />
	<property name="tomcatConfigPostDeploymentCommands" value="tomcatConfigPostDeploymentCommands.txt" />

	<path id="project.class.path">
		<fileset dir="${project.dir}/WebContent/WEB-INF/lib/">
			<include name="*.jar" />
		</fileset>
		

		<fileset dir="${project.dir}/tomcat/lib/">
			<include name="*.jar" />
		</fileset>
	</path>
	

	<path id="bin.class.path">
		<fileset dir="${bin.dir}/lib">
			<include name="*.jar" />
		</fileset>
	</path>
	

	<pathconvert property="lib.bin.manifest.classpath" pathsep=" ">
		<path refid="bin.class.path" />
		<flattenmapper />
		<map from="" to="lib/" />
	</pathconvert>

	<!-- deployment dir -->
	<property name="datafari.dist.dir" value="/opt/datafari-server" />
	<property name="tomcat.dist.dir" value="${datafari.dist.dir}/tomcat" />
	<property name="jvm.dist.dir" value="${datafari.dist.dir}/jvm" />
	<property name="pgsql.dist.dir" value="${datafari.dist.dir}/pgsql" />
	<property name="bin.dist.dir" value="${datafari.dist.dir}/bin" />
	<property name="datafariwebapp.dist.dir" value="${tomcat.dist.dir}/webapps/Datafari" />
	<property name="manifoldcf.dist.dir" value="${datafari.dist.dir}/ManifoldCF" />
	<property name="solr.dist.dir" value="${datafari.dist.dir}/Solr" />






	<target name="clean">
		<delete includeemptydirs="true">
			<fileset dir="${build.dir}" includes="**/*" />
		</delete>
		<delete includeemptydirs="true">
			<fileset dir="${dist.dir}" includes="**/*" />
		</delete>
		<delete includeemptydirs="true">
			<fileset dir="${deploy.dir}" includes="**/*" />
		</delete>
		<delete includeemptydirs="true">
			<fileset dir="${bin.dir}/build" includes="**/*" />
		</delete>
		<delete includeemptydirs="true">
			<fileset dir="${bin.dir}/dist" includes="**/*" />
		</delete>
	</target>


	
	<target name="compileBin" depends="clean">
			<echo message="${build.classes.dir}" />
			<mkdir dir="${bin.dir}/build" />
			<copy todir="${bin.dir}/build">
				<fileset dir="${bin.dir}/src" />
			</copy>
			<javac destdir="${bin.dir}/build" debug="on" debuglevel="lines,vars,source" verbose="off" source="1.7" target="1.7">
				<classpath refid="bin.class.path" />
				<src path="${bin.dir}/src" />
			</javac>
		</target>
	

	<target name="distBin" depends="compileBin">

		<mkdir dir="${bin.dir}/dist/logs" />
		<jar destfile="${bin.dir}/dist/DatafariScripts.jar" basedir="${bin.dir}/build">
			<manifest>
				<attribute name="Class-Path" value="${lib.bin.manifest.classpath}" />
			</manifest>
			<fileset dir="${bin.dir}\lib" includes="**" />
		</jar>

		<copy todir="${bin.dir}/dist/lib">
			<fileset dir="${bin.dir}/lib" />
		</copy>
		<copy todir="${bin.dir}/dist/config">
			<fileset dir="${bin.dir}/config" />
		</copy>
		<copy todir="${bin.dir}/dist">
			<fileset dir="${bin.dir}/main" />
		</copy>

	</target>

	<target name="compileCore" depends="distBin">
		<echo message="${build.classes.dir}" />
		<mkdir dir="${build.classes.dir}" />
		<copy todir="${build.classes.dir}">
			<fileset dir="${project.dir}/src" />
		</copy>
		<javac destdir="${build.classes.dir}" debug="on" debuglevel="lines,vars,source" verbose="off" source="1.7" target="1.7">
			<classpath refid="project.class.path" />
			<src path="${project.dir}/src" />
		</javac>
	</target>

	<target name="distCore" depends="compileCore">

		<copy todir="${dist.dir}">
			<fileset dir="${webcontent.dir}/">
				<include name="**" />
			</fileset>
		</copy>
		
		<copy todir="${dist.dir}/WEB-INF">
			<fileset dir="${build.dir}/">
				<include name="**" />
			</fileset>
		</copy>

	</target>

	<target name="prepareDeployment" depends="distCore">
		<!-- Create directory for deployment -->
		<exec executable="putty.exe">
			<arg value="-P" />
			<arg value="${ftp-port}" />
			<arg value="${ftp-userid}@${ftp-server}" />
			<arg value="-pw" />
			<arg value="${ftp-password}" />
			<arg value="-m" />
			<arg value="${pre-deploy-commands}" />
		</exec>
	</target>
	
	<target name="deployDatafari" >
		<zip destfile="${deploy.dir}/${project.name}.zip" basedir="${dist.dir}" />

		<exec executable="pscp.exe">
			<arg value="-P" />
			<arg value="${ftp-port}" />
			<arg value="-v" />
			<arg value="-pw" />
			<arg value="${ftp-password}" />
			<arg value="${deploy.dir}/${project.name}.zip" />
			<arg value="${ftp-userid}@${ftp-server}:${datafariwebapp.dist.dir}" />
		</exec>
		

		<exec executable="putty.exe">
			<arg value="-P" />
			<arg value="${ftp-port}" />
			<arg value="${ftp-userid}@${ftp-server}" />
			<arg value="-pw" />
			<arg value="${ftp-password}" />
			<arg value="-m" />
			<arg value="${datafariPostDeploymentCommands}" />
		</exec>
		
	</target>
	
	<target name="deploySolrConfig" >
			<zip destfile="${deploy.dir}/SolrConfig.zip" basedir="${solr.dir}/SolrHome/FileShare/conf" />

			<exec executable="pscp.exe">
				<arg value="-P" />
				<arg value="${ftp-port}" />
				<arg value="-v" />
				<arg value="-pw" />
				<arg value="${ftp-password}" />
				<arg value="${deploy.dir}/SolrConfig.zip" />
				<arg value="${ftp-userid}@${ftp-server}:${solr.dist.dir}/SolrHome/FileShare/conf" />
			</exec>
			

			<exec executable="putty.exe">
				<arg value="-P" />
				<arg value="${ftp-port}" />
				<arg value="${ftp-userid}@${ftp-server}" />
				<arg value="-pw" />
				<arg value="${ftp-password}" />
				<arg value="-m" />
				<arg value="${solrConfigPostDeploymentCommands}" />
			</exec>
			
		</target>
	

	<target name="deployTomcatConf" >
			<zip destfile="${deploy.dir}/Tomcat.zip" basedir="${tomcat.dir}" includes="conf/**, bin/**" />

			<exec executable="pscp.exe">
				<arg value="-P" />
				<arg value="${ftp-port}" />
				<arg value="-v" />
				<arg value="-pw" />
				<arg value="${ftp-password}" />
				<arg value="${deploy.dir}/Tomcat.zip" />
				<arg value="${ftp-userid}@${ftp-server}:${tomcat.dist.dir}" />
			</exec>
			

			<exec executable="putty.exe">
				<arg value="-P" />
				<arg value="${ftp-port}" />
				<arg value="${ftp-userid}@${ftp-server}" />
				<arg value="-pw" />
				<arg value="${ftp-password}" />
				<arg value="-m" />
				<arg value="${tomcatConfigPostDeploymentCommands}" />
			</exec>
			
		</target>
	
	<target name="deployAll" depends="prepareDeployment">
		


		
		
		<echo message="Zipping dist directory" />
		<zip destfile="${deploy.dir}/ManifoldCFHome.zip" basedir="${manifoldcf.dir}/ManifoldCFHome" />
		<zip destfile="${deploy.dir}/SolrHome.zip" basedir="${solr.dir}/SolrHome" />
		<zip destfile="${deploy.dir}/Tomcat.zip" basedir="${tomcat.dir}" />
		<zip destfile="${deploy.dir}/JVM.zip" basedir="${jvm.dir}" />
		<zip destfile="${deploy.dir}/PGSQL.zip" basedir="${pgsql.dir}" />
		<zip destfile="${deploy.dir}/Bin.zip" basedir="${bin.dir}/dist" />
		<zip destfile="${deploy.dir}/${project.name}.zip" basedir="${dist.dir}" />

		
		
		
		<exec executable="pscp.exe">
			<arg value="-P" />
			<arg value="${ftp-port}" />
			<arg value="-v" />
			<arg value="-pw" />
			<arg value="${ftp-password}" />
			<arg value="${deploy.dir}/ManifoldCFHome.zip" />
			<arg value="${ftp-userid}@${ftp-server}:${manifoldcf.dist.dir}/ManifoldCFHome" />
		</exec>
		
		<exec executable="pscp.exe">
					<arg value="-P" />
					<arg value="${ftp-port}" />
					<arg value="-v" />
					<arg value="-pw" />
					<arg value="${ftp-password}" />
					<arg value="${manifoldcf.dir}/war/*" />
					<arg value="${ftp-userid}@${ftp-server}:${manifoldcf.dist.dir}/war" />
				</exec>
		<exec executable="pscp.exe">
					<arg value="-P" />
					<arg value="${ftp-port}" />
					<arg value="-v" />
					<arg value="-pw" />
					<arg value="${ftp-password}" />
					<arg value="${script.dir}/*" />
					<arg value="${ftp-userid}@${ftp-server}:/etc/init.d/" />
				</exec>
		
		<exec executable="pscp.exe">
							<arg value="-P" />
							<arg value="${ftp-port}" />
							<arg value="-v" />
							<arg value="-pw" />
							<arg value="${ftp-password}" />
							<arg value="${project.dir}/unzip" />
							<arg value="${ftp-userid}@${ftp-server}:/usr/bin" />
						</exec>
		
		<exec executable="pscp.exe">
			<arg value="-P" />
			<arg value="${ftp-port}" />
			<arg value="-v" />
			<arg value="-pw" />
			<arg value="${ftp-password}" />
			<arg value="${deploy.dir}/SolrHome.zip" />
			<arg value="${ftp-userid}@${ftp-server}:${solr.dist.dir}/SolrHome" />
		</exec>
		
		<exec executable="pscp.exe">
					<arg value="-P" />
					<arg value="${ftp-port}" />
					<arg value="-v" />
					<arg value="-pw" />
					<arg value="${ftp-password}" />
					<arg value="${deploy.dir}/Tomcat.zip" />
					<arg value="${ftp-userid}@${ftp-server}:${tomcat.dist.dir}" />
				</exec>
		

		<exec executable="pscp.exe">
					<arg value="-P" />
					<arg value="${ftp-port}" />
					<arg value="-v" />
					<arg value="-pw" />
					<arg value="${ftp-password}" />
					<arg value="${deploy.dir}/JVM.zip" />
					<arg value="${ftp-userid}@${ftp-server}:${jvm.dist.dir}" />
				</exec>
		
		<exec executable="pscp.exe">
							<arg value="-P" />
							<arg value="${ftp-port}" />
							<arg value="-v" />
							<arg value="-pw" />
							<arg value="${ftp-password}" />
							<arg value="${deploy.dir}/PGSQL.zip" />
							<arg value="${ftp-userid}@${ftp-server}:${pgsql.dist.dir}" />
						</exec>
		
		<exec executable="pscp.exe">
					<arg value="-P" />
					<arg value="${ftp-port}" />
					<arg value="-v" />
					<arg value="-pw" />
					<arg value="${ftp-password}" />
					<arg value="${solr.dir}/war/*" />
					<arg value="${ftp-userid}@${ftp-server}:${solr.dist.dir}/war" />
				</exec>
		
		<exec executable="pscp.exe">
					<arg value="-P" />
					<arg value="${ftp-port}" />
					<arg value="-v" />
					<arg value="-pw" />
					<arg value="${ftp-password}" />
					<arg value="${deploy.dir}/Bin.zip" />
					<arg value="${ftp-userid}@${ftp-server}:${bin.dist.dir}" />
				</exec>
		


		<exec executable="pscp.exe">
			<arg value="-P" />
			<arg value="${ftp-port}" />
			<arg value="-v" />
			<arg value="-pw" />
			<arg value="${ftp-password}" />
			<arg value="${deploy.dir}/${project.name}.zip" />
			<arg value="${ftp-userid}@${ftp-server}:${datafariwebapp.dist.dir}" />
		</exec>
		

		<exec executable="putty.exe">
			<arg value="-P" />
			<arg value="${ftp-port}" />
			<arg value="${ftp-userid}@${ftp-server}" />
			<arg value="-pw" />
			<arg value="${ftp-password}" />
			<arg value="-m" />
			<arg value="${environnementPostDeploymentCommands}" />
		</exec>
		<echo message="Done" />
	</target>

</project>
